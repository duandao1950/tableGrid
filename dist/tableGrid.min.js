/*! tableGrid on jQuery UI - v0.1.0 - 2012-12-05
* https://github.com/Ysudo/tableGrid
* Copyright (c) 2012 Yun Sudong; Licensed MIT */
(function(c){c.widget("ui.tableGrid",{options:{mode:"Table",template:"",tplhandle:null,mtype:"post",colModel:[],showHead:!0,url:"",urlData:{},height:"auto",width:"auto",viewWidth:"auto",scrolling:!1,button:[],showpage:!0,isCheckbox:null,showViewNum:!0,rowNum:10,rowList:"10,20,30",nowPage:1,altRows:!0,ajaxSetup:{},success:null,failure:null},_itemOldWidth:[],_alltWidth:0,_thisData:null,_oldWidth:0,_isLoading:!1,_create:function(){if(this.options.url){this.element.addClass("ui-tbgrid ui-widget ui-widget-content ui-corner-all");
c("<div class='ui-tbgrid-viewwidth' ><div class='ui-widget-header ui-tbgrid-hd'></div><div class='ui-tbgrid-main'></div></div><div class='ui-widget-header ui-tbgrid-button-col'></div><div class='ui-widget-header ui-tbgrid-foot'></div>").appendTo(this.element);this._initSetWidth();var a=c("<div></div>").addClass("ui-widget-overlay ui-helper-hidden").appendTo(this.element);c.fn.bgiframe&&a.bgiframe();this.options.scrolling&&c('<div class="ui-tbgrid-loading"></div>').appendTo(this.element.find(".ui-tbgrid-main"));
this._oldWidth=this.element.width();this._createHead();this._getData(function(){this._createMain();this._createFoot();this._createButton();this.options.success&&this.options.success(this,this._thisData);c(window).resize(c.proxy(this._refreshWidth,this))})}},_createHead:function(){var a=this.element.find(".ui-tbgrid-hd");a.empty();var e=this.options.colModel.length,f=this;this._itemOldWidth=[];"radio"==this.options.isCheckbox?c('<div class="ui-tbgrid-hd-checkbox"><span>\u9009\u62e9</span></div>').appendTo(a):
"multiple"==this.options.isCheckbox&&c('<div class="ui-tbgrid-hd-checkbox"><span>\u5168\u9009</span></div>').toggle(function(){c(this).html("<span>\u53d6\u6d88</span>");f.element.find(".ui-tbgrid-main > .ui-tbgrid-tr").addClass("selected")},function(){c(this).html("<span>\u5168\u9009</span>");f.element.find(".ui-tbgrid-main > .ui-tbgrid-tr").removeClass("selected")}).appendTo(a);for(var d=0;d<e;d++){var b=c.extend({align:"left",order:"",width:"auto"},this.options.colModel[d]),g=[];g.push('<div class="ui-tbgrid-th ui-tbgrid-title_'+
b.data+'" style="text-align:'+b.align+"; width:"+b.width+'">');b.order?(g.push('<span data-sort="normal" data-name="'+b.data+'" class="ui-tbgrid-order normal" title="\u6309\u6b64\u5b57\u6bb5\u6392\u5e8f">'+b.name+"</span>"),f.options.urlData.orderName=b.data,f.options.urlData.orderSort=b.order):g.push("<span>"+b.name+"</span>");g.push("</div>");b=c(g.join("")).appendTo(a);this._alltWidth+=b.width();this._itemOldWidth.push(b.width())}a.find(".ui-tbgrid-title_"+this.options.urlData.orderName+" > span").attr("class","ui-tbgrid-order "+
this.options.urlData.orderSort).attr("data-sort",this.options.urlData.orderSort);a.find("div").last().addClass("ui-tbgrid-th-last");!this.options.showHead&&a.hide();this._setWidth();this._setOrder()},_createFoot:function(){var a=this.element.find(".ui-tbgrid-foot");a.empty();this.options.scrolling?a.hide():this.options.showpage?this._createPager():a.hide()},_createButton:function(){var a=this.element.find(".ui-tbgrid-button-col");a.empty();if(0<this.options.button.length){var e=c('<div class="ui-tbgrid-button"></div>');
c.each(this.options.button,function(a,d){var b=c("<button>").html(d.text);b.button({icons:d.icons});b.click(d.onclick);b.appendTo(e)});e.prependTo(a)}},_createMain:function(){var a=this.element.find(".ui-tbgrid-main");!this.options.scrolling&&a.empty();var e=this.options.colModel.length,f=this._thisData.rows.length;if(0==f)c('<div class="ui-state-highlight ui-corner-all" style="width: '+(this.options.viewWidth-20)+'px" > <p><span class="ui-icon ui-icon-info"></span><strong>\u6682\u65e0\u6570\u636e\uff01</strong> \u8bf7\u4fee\u6539\u67e5\u8be2\u6761\u4ef6\u91cd\u8bd5</p></div>').appendTo(a);
else{switch(this.options.mode){case "Table":for(var d=0;d<f;d++){var b=[];b.push('<div class="ui-tbgrid-tr">');this.options.isCheckbox&&b.push('<div class="ui-tbgrid-checkbox"><span class="ui-tbgrid-item-'+this.options.isCheckbox+'"></span></div>');for(var g=0;g<e;g++){var h=c.extend({align:"left",order:"",width:"auto",handle:null},this.options.colModel[g]);b.push('<div class="ui-tbgrid-td" style="text-align:'+h.align+"; width:"+h.width+'px">');var j=h.handle?h.handle(this._thisData.rows[d][h.data],
this._thisData.rows[d]):this._thisData.rows[d][h.data];b.push('<div class="ui-tbgrid-text ui-tbgrid-text-'+h.data+'">'+j+"</div>");b.push("</div>")}b.push("</div>");b=this.options.scrolling?c(b.join("")).insertBefore(this.element.find(".ui-tbgrid-loading")):c(b.join("")).appendTo(a);b.data("data-all",this._thisData.rows[d]);b.find(".ui-tbgrid-td").last().addClass("ui-tbgrid-td-last")}break;case "Template":f=this._thisData.rows.length;for(d=0;d<f;d++)e=this.options.tplhandle?this.options.tplhandle(this._thisData.rows[d]):
this._thisData.rows[d],b=c('<div class="ui-tbgrid-tr"></div>').html(template(this.options.template,e)),b.appendTo(a);break;default:throw"options mode error";}this.options.scrolling&&this._setScrolling();this._setAltRows();this._refreshWidth()}this._isLoading=!1;this.element.find(".ui-widget-overlay").fadeOut()},_createPager:function(){var a=this.element.find(".ui-tbgrid-foot"),e=this._thisData.total/this.options.rowNum,f=this.options.nowPage,d=this,f=this._checkPage(f,e);this.options.nowPage=f;var e=
Math.ceil(e),b="",g=f-1,h=f+1;if(this.options.showViewNum){var b=b+'<div class="ui-tbgrid-sizer"><span class="ui-tbgrid-explain">\u6bcf\u9875\u663e\u793a\u6570\u91cf</span>',j=c.isArray(this.options.rowList)?this.options.rowList:this.options.rowList.split(",");jQuery.each(j,function(a){b+='<a href="#" data:view="'+j[a]+'" class="ui-page-view '+(j[a]==d.options.rowNum?"active":"")+'">'+j[a]+"</a>"});b+="</div>"}b+='<div class="ui-tbgrid-pager"><span class="ui-tbgrid-explain">\u5171'+this._thisData.total+"\u6761\u8bb0\u5f55</span>";b=1>g?b+'<a href="#" title="\u5df2\u662f\u6700\u524d\u4e00\u9875" data:page="0" class="page-prev page-prev-disabled">\u5df2\u662f\u6700\u524d\u4e00\u9875</a>':
b+('<a href="#" title="\u4e0a\u4e00\u9875" data:page="'+g+'" class="page-prev">\u4e0a\u4e00\u9875</a>');b=1==f?b+'<a href="#" title="\u7b2c 1 \u9875" data:page="1" class="ui-page-num active"><span>1</span></a>':b+'<a href="#" title="\u7b2c 1 \u9875" data:page="1" class="ui-page-num"><span>1</span></a>';g=3<f?f-3:1;g>e-6&&0<e-6&&(g=e-6);1<g&&(b+='<span class="page-break">...</span>');for(var i=g+1;i<g+6&&!(i>=e);i++)b=i==f?b+('<a href="#" title="\u7b2c '+i+' \u9875" data:page="'+i+'" class="ui-page-num active"><span>'+i+"</span></a>"):b+('<a href="#" title="\u7b2c '+
i+' \u9875" data:page="'+i+'" class="ui-page-num"><span>'+i+"</span></a>");e>g+6&&(b+='<span class="page-break">...</span>');1<e&&(b=f==e?b+('<a href="#" title="\u7b2c '+e+' \u9875" data:page="'+e+'" class="ui-page-num active"><span> '+e+" </span></a>"):b+('<a href="#" title="\u7b2c '+e+' \u9875" data:page="'+e+'" class="ui-page-num"><span> '+e+" </span></a>"));b=h>e?b+('<a href="#" title="\u5df2\u662f\u6700\u540e\u4e00\u9875" data:page="'+e+'" class="page-next page-next-disabled">\u5df2\u662f\u6700\u540e\u4e00\u9875</a>'):b+('<a href="#" title="\u4e0b\u4e00\u9875" data:page="'+h+'" class="page-next">\u4e0b\u4e00\u9875</a>');
b+='<span class="explain">\u5230\u7b2c</span> <input type="text" class="ui-tbgrid-jump-page" maxlength="4"/> <span class="explain">\u9875</span><a href="#" class="ui-tbgrid-jump-btn" ><span>\u786e\u5b9a</span></a>';b+="</div>";c(b).appendTo(a);a.find("a.ui-page-num , a.ui-page-view , a.ui-tbgrid-jump-btn").button({create:function(){c(this).hasClass("active")&&c(this).button("disable")}});a.find("a.page-prev").button({text:!1,icons:{primary:"ui-icon-seek-prev"},create:function(){c(this).hasClass("page-prev-disabled")&&c(this).button("disable")}});
a.find("a.page-next").button({text:!1,icons:{primary:"ui-icon-seek-next"},create:function(){c(this).hasClass("page-next-disabled")&&c(this).button("disable")}});a.find("a.ui-page-num , a.page-prev , a.page-next").click(function(a){a.preventDefault();c(this).button("disable");d.options.nowPage=d._checkPage(c(this).attr("data:page"),e);d._getData(function(){d._createMain();d._createFoot();d.options.success&&d.options.success(d,this._thisData)})});a.find("a.ui-page-view").click(function(a){a.preventDefault();
c(this).button("disable");d.options.nowPage=1;d.options.rowNum=c(this).attr("data:view");d._getData(function(){d._createMain();d._createFoot();d.options.success&&d.options.success(d,this._thisData)})});a.find("a.ui-tbgrid-jump-btn").click(function(b){b.preventDefault();b=a.find(".ui-tbgrid-jump-page");""==b.val()||isNaN(parseInt(b.val()))?b.val(""):(c(this).button("disable"),d.options.nowPage=d._checkPage(b.val(),e),d._getData(function(){d._createMain();d._createFoot();d.options.success&&d.options.success(d,
this._thisData)}))});a.find("input.ui-tbgrid-jump-page").keypress(function(a){13==a.keyCode&&(a=c(this),""==a.val()||isNaN(parseInt(a.val()))?a.val(""):(d.options.nowPage=d._checkPage(a.val(),e),d._getData(function(){d._createMain();d._createFoot();d.options.success&&d.options.success(d,this._thisData)})))})},_checkPage:function(a,c){isNaN(parseInt(a))&&(a=1);1>a&&(a=1);a>c&&(a=c);return a=Math.ceil(a)},_getData:function(a){!this.options.scrolling&&this.element.find(".ui-widget-overlay").show();var e=
this,f={};f.url=this.options.url;f.type=this.options.mtype;f.data=this.options.showpage?c.extend({rowNum:this.options.rowNum,page:this.options.nowPage},this.options.urlData):this.options.urlData;f.dataType="json";f.success=function(c){c?(e._thisData=c,a&&a.apply(e)):f.error()};f.error=function(a){e.element.find(".ui-widget-overlay").fadeOut();var b=e.element.find(".ui-tbgrid-main");b.empty();a&&403!=a.status?c('<div class="ui-state-error ui-corner-all" style="width: '+(e.options.viewWidth-20)+'px"> <p><span class="ui-icon ui-icon-alert"></span> <strong>\u9519\u8bef:</strong> \u60a8\u6ca1\u6709\u6743\u9650\u8fdb\u884c\u6b64\u64cd\u4f5c\uff01 </p></div>').appendTo(b):
c('<div class="ui-state-error ui-corner-all" style="width: '+(e.options.viewWidth-20)+'px"> <p><span class="ui-icon ui-icon-alert"></span> <strong>\u9519\u8bef:</strong> \u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5 </p></div>').appendTo(b);e.option.failure&&e.options.failure(this,a);throw"url error";};f.complete=function(){};c.ajax(c.extend(f,this.options.ajaxSetup))},_setOrder:function(){var a=this,e=this.element.find(".ui-tbgrid-order");e.click(function(){var f=c(this).attr("data-sort");"normal"==f?(a.options.urlData.orderName=c(this).attr("data-name"),
a.options.urlData.orderSort="desc",e.attr("class","ui-tbgrid-order normal").attr("data-sort","normal"),c(this).removeClass("normal").addClass("desc"),c(this).attr("data-sort","desc")):"desc"==f?(a.options.urlData.orderName=c(this).attr("data-name"),a.options.urlData.orderSort="asc",e.attr("class","ui-tbgrid-order normal").attr("data-sort","normal"),c(this).removeClass("normal").addClass("asc"),c(this).attr("data-sort","asc")):"asc"==f&&(a.options.urlData.orderName=c(this).attr("data-name"),a.options.urlData.orderSort=
"normal",e.attr("class","ui-tbgrid-order normal").attr("data-sort","normal"));a.refresh()})},_setWidth:function(a){"auto"!=this.options.width&&(a=this.options.width);if(!a||"auto"==a)a=parseInt(this.element.width(),10);this.options.isCheckbox&&(a-=50);var e=parseInt((a-this._alltWidth-this.options.colModel.length-20)/this.options.colModel.length,10),f=this._itemOldWidth.length,d=this._itemOldWidth;this.element.find(".ui-tbgrid-tr").each(function(a,g){for(var h=[],j=0;j<f;j++){var i=c(g).find(".ui-tbgrid-td").eq(j);
i.width(d[j]+e);h.push(i.height())}c(g).find(".ui-tbgrid-td , .ui-tbgrid-checkbox").height(h.sort(function(a,b){return a>b?1:-1}).pop())});for(a=0;a<f;a++)this.element.find(".ui-tbgrid-hd div:not(.ui-tbgrid-hd-checkbox)").eq(a).width(d[a]+e)},_setScrolling:function(){var a=this.element.find(".ui-tbgrid-main");a.scroll(c.proxy(function(){a.height()+a.scrollTop()+36>a.get(0).scrollHeight&&!this._isLoading&&(this.options.nowPage+=1,this._isLoading=!0,this._getData(function(){this._createMain()}))},this))},
_setAltRows:function(){var a=this.element.find(".ui-tbgrid-main > .ui-tbgrid-tr");this.options.altRows&&(this.element.find(".ui-tbgrid-main > .ui-tbgrid-tr:nth-child(even)").addClass("odd"),a.unbind("hover").hover(function(){c(this).addClass("over")},function(){c(this).removeClass("over")}));var e=this;a.unbind("click").bind("click",function(){c(this).hasClass("selected")?c(this).removeClass("selected"):("multiple"!=e.options.isCheckbox&&c(this).siblings(".ui-tbgrid-tr.selected").removeClass("selected"),
c(this).addClass("selected"))})},_refreshWidth:function(){this._initSetWidth();this._setWidth(this.element.width())},_initSetWidth:function(){if("auto"==this.options.viewWidth&&this.element.width()>this.options.width||"auto"!=this.options.viewWidth&&this.options.viewWidth>this.options.width)this.options.width="auto";this.element.css({});this.element.find(".ui-tbgrid-hd").css({width:this.options.width});var a=this.options.height;this.options.scrolling&&"auto"==this.options.height&&(a=18*this.options.rowNum);
this.element.find(".ui-tbgrid-main").css({height:a,width:this.options.width});this.element.find(".ui-tbgrid-viewwidth").css({width:this.options.viewWidth});jQuery.util.ua.ie67&&this.element.find(".ui-tbgrid-viewwidth").css({height:a+50})},refresh:function(){this.options.scrolling||this._getData(function(){this._createMain();this.options.success&&this.options.success(this,this._thisData)})},query:function(a){this.options.urlData=a;this.options.nowPage=1;this._getData(function(){this._createMain();
this._createFoot();this._createButton();this.options.success&&this.options.success(this,this._thisData)})},getSelected:function(){var a=[];c.each(c(this.element.find(".ui-tbgrid-tr.selected")),function(e,f){a.push(c(f).data("data-all"))});return a}});c.extend(c.ui.tableGrid,{version:"1.1.0"})})(jQuery);
;